<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>È¢®Â°µÂçúÂçú</title>
    <style>
        /* CSS ‰øùÊåÅ‰∏çËÆä */
        html, body {
            height: 100%; 
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #0d1226; 
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center; 
            min-height: 100vh;
            overflow: hidden; 
            position: relative;
        }

        .quiz-container {
            width: 100%;
            max-width: 480px;
            max-height: 100vh;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            height: auto; 
            visibility: hidden; 
            opacity: 0;
            transition: visibility 0s 0.5s, opacity 0.5s linear;
        }

        .quiz-container.loaded {
            visibility: visible;
            opacity: 1;
            transition-delay: 0s;
        }

        #quiz-image {
            width: 100%;
            display: block;
            max-height: 100vh; 
            height: auto;
            z-index: 1; 
        }

        #button-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5; 
            pointer-events: none;
        }

        .option-button {
            position: absolute;
            background-color: transparent; 
            border: none;                  
            cursor: pointer;
            z-index: 10; 
            color: transparent !important; 
            font-size: 0 !important;       
            line-height: 0 !important;     
            text-indent: -9999px;          
            overflow: hidden; 
            pointer-events: auto;
        }
        
        .start-cover-button {
            width: 60%; 
            left: 20%;  
            top: 25%;   
            height: 9%; 
        }

        .start-bottom-button {
            width: 50%; 
            left: 25%;  
            top: 88%; 
            height: 10%; 
        }

        .q-btn-a { top: 48%; left: 10%; width: 80%; height: 7%; }
        .q-btn-b { top: 58%; left: 10%; width: 80%; height: 7%; }
        .q-btn-c { top: 68%; left: 10%; width: 80%; height: 7%; }
        .q-btn-d { top: 78%; left: 10%; width: 80%; height: 7%; }

        .result-btn-share {
            top: 90%; 
            left: 8%; 
            width: 28%;
            height: 7%;
        }
        .result-btn-replay {
            top: 90%; 
            left: 36%; 
            width: 28%;
            height: 7%;
        }
        .result-btn-signup {
            top: 90%; 
            left: 64%; 
            width: 28%;
            height: 7%;
        }

        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0d1226;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 1.2em;
            z-index: 9999;
            transition: opacity 0.5s linear;
        }
        #loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <p style="margin-top: 10px;" id="loading-message">ËºâÂÖ•‰∏≠...</p>
</div>

<div class="quiz-container">
    <img id="quiz-image" src="cover.png" alt="Ê∏¨È©óÂ∞ÅÈù¢">
    
    <div id="button-area">
        </div>
</div>

<script>
    const LECTURE_URLS = {
        'ÊçèÊçè': 'https://forms.gle/PvwhsYqJ7uAAqcrQ8',     
        'ÂäâÂèàÁÜä': 'https://forms.gle/4C3PAuXNZKUm4CN98',   
        'ÊûóÊòìÁ•∫': 'https://forms.gle/5SHN6fTp3p6397vs8'    
    };

    // **‰øÆÊ≠£ÈªûÔºöÁ¢∫ÂÆöÊòØ .png**
    const PAGE_IMAGES = [
        'cover.png', 'intro.png', 'q1.png', 'q2.png', 'q3.png', 
        'q4.png', 'q5.png', 'q6.png', 'gotoresult.png'    
    ];
    
    const RESULT_DETAILS = {
        'R1': { file: 'result_star.png', lecture: 'ÊçèÊçè' },      
        'R2': { file: 'result_sun.png', lecture: 'ÊçèÊçè' },       
        'R3': { file: 'result_foggy.png', lecture: 'ÂäâÂèàÁÜä' },    
        'R4': { file: 'result_sunset.png', lecture: 'ÂäâÂèàÁÜä' },   
        'R5': { file: 'result_dawn.png', lecture: 'ÊûóÊòìÁ•∫' },     
        'R6': { file: 'result_moon.png', lecture: 'ÊûóÊòìÁ•∫' }      
    };

    // Ë®àÂàÜÈÇèËºØ‰øùÊåÅ‰∏çËÆä
    const RESULT_MAPPING = [
        { 1: ['R2'], 2: ['R5', 'R3'], 3: ['R4'], 4: ['R1', 'R6'] }, 
        { 1: ['R5', 'R3'], 2: ['R2'], 3: ['R1', 'R6'], 4: ['R4'] },
        { 1: ['R2'], 2: ['R1', 'R6'], 3: ['R4'], 4: ['R3', 'R5'] },
        { 1: ['R2'], 2: ['R3'], 3: ['R5'], 4: ['R1'] },
        { 1: ['R2'], 2: ['R3'], 3: ['R5'], 4: ['R4'] },
        { 1: ['R5'], 2: ['R2'], 3: ['R3'], 4: ['RANDOM'] }
    ];

    let currentPage = 0; 
    let userAnswers = []; 
    let finalResultKey = '';
    let isInitialized = false; 

    const quizImage = document.getElementById('quiz-image');
    const buttonArea = document.getElementById('button-area');
    const quizContainer = document.querySelector('.quiz-container');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingMessage = document.getElementById('loading-message');

    function preloadAllImages() {
        const imagesToPreload = [
            ...PAGE_IMAGES, 
            ...Object.values(RESULT_DETAILS).map(r => r.file)
        ];
        
        const imagePromises = imagesToPreload.map(src => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = src;
                img.onload = resolve;
                img.onerror = () => {
                    console.warn(`Warning: Image failed to load: ${src}. Proceeding anyway.`);
                    resolve(); 
                }; 
            });
        });

        return Promise.all(imagePromises);
    }

    // --- Ê†∏ÂøÉÂïüÂãïÂáΩÊï∏ ---
    function startQuiz() {
        if (isInitialized) return; 
        isInitialized = true;

        loadingOverlay.classList.add('hidden');
        quizContainer.classList.add('loaded');
        navigate(0);
    }
    
    // ... (ÂÖ∂‰ªñ Helper Functions ‰øùÊåÅ‰∏çËÆäÔºåÁï•ÈÅé‰ª•Á∂≠ÊåÅÁ∞°ÊΩî) ...
    function setPageImage(imageFileName) {
        quizImage.src = imageFileName;
        buttonArea.innerHTML = ''; 
        document.querySelectorAll('.quiz-container > .option-button').forEach(btn => {
            btn.remove();
        });
    }

    function renderStartButton(callback, buttonClass, parentElement) {
        const button = document.createElement('button');
        button.className = `option-button ${buttonClass}`; 
        button.onclick = callback;
        parentElement.appendChild(button);
    }

    function renderQuizButtons(questionIndex, parentElement) {
        const classes = ['q-btn-a', 'q-btn-b', 'q-btn-c', 'q-btn-d'];
        for (let i = 0; i < 4; i++) {
            const button = document.createElement('button');
            const answerValue = i + 1; 
            
            button.className = `option-button ${classes[i]}`;
            button.onclick = () => {
                userAnswers[questionIndex] = answerValue;
                if (questionIndex < 5) {
                    navigate(currentPage + 1);
                } else {
                    navigate(8); 
                }
            };
            parentElement.appendChild(button);
        }
    }

    function navigate(nextPage) {
        currentPage = nextPage;
        if (currentPage < PAGE_IMAGES.length) {
            setPageImage(PAGE_IMAGES[currentPage]);
            
            if (currentPage === 0) {
                renderStartButton(() => navigate(1), 'start-cover-button', buttonArea); 
            } else if (currentPage === 1) {
                renderStartButton(() => navigate(2), 'start-bottom-button', buttonArea); 
            } else if (currentPage >= 2 && currentPage <= 7) {
                renderQuizButtons(currentPage - 2, buttonArea); 
            } else if (currentPage === 8) {
                renderStartButton(calculateResult, 'start-bottom-button', buttonArea); 
            }
        } 
    }

    function calculateResult() {
        const resultKeys = ['R1', 'R2', 'R3', 'R4', 'R5', 'R6'];
        let resultCounts = { 'R1': 0, 'R2': 0, 'R3': 0, 'R4': 0, 'R5': 0, 'R6': 0 };

        userAnswers.forEach((answerValue, questionIndex) => {
            const mappings = RESULT_MAPPING[questionIndex];
            const resultList = mappings[answerValue]; 

            if (resultList && resultList[0] === 'RANDOM') {
                const randomIndex = Math.floor(Math.random() * resultKeys.length);
                resultCounts[resultKeys[randomIndex]] += 1;
            } else if (resultList) {
                resultList.forEach(key => {
                    resultCounts[key] += 1;
                });
            }
        });

        let maxCount = -1;
        let finalResultCandidates = [];
        for (const key of resultKeys) {
            const count = resultCounts[key];
            if (count > maxCount) {
                maxCount = count;
                finalResultCandidates = [key]; 
            } else if (count === maxCount && maxCount > 0) {
                finalResultCandidates.push(key); 
            }
        }
        
        if (finalResultCandidates.length === 0) {
            const randomIndex = Math.floor(Math.random() * resultKeys.length);
            finalResultKey = resultKeys[randomIndex];
        } else if (finalResultCandidates.length === 1) {
            finalResultKey = finalResultCandidates[0];
        } else {
            const randomIndex = Math.floor(Math.random() * finalResultCandidates.length);
            finalResultKey = finalResultCandidates[randomIndex];
        }

        renderResultPage();
    }

    function renderResultPage() {
        currentPage = 9; 
        const result = RESULT_DETAILS[finalResultKey];
        setPageImage(result.file);

        renderStartButton(() => {
            if (navigator.share) {
                navigator.share({
                    title: 'ùüÆùü¨ùüÆùü≤ Èõ®Â±±Á•≠ ùó°ùóñùóñùó® ùó†ùòÇùòÄùó∂ùó∞ ùóôùó≤ùòÄùòÅùó∂ùòÉùóÆùóπ',
                    text: 'Âç†Âçú',
                    url: window.location.href, 
                }).catch(() => {});
            } else {
                alert('Á≥ªÁµ±ÂàÜ‰∫´ÂäüËÉΩÂ§±ÊïàÔºåÂ∞áÂòóË©¶‰∏ãËºâÂúñÁâá„ÄÇ'); 
            }

            const imageUrl = quizImage.src;
            if (imageUrl) {
                link.href = imageUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }, 'result-btn-share', quizContainer);

        renderStartButton(() => {
            userAnswers = []; 
            navigate(0); 
        }, 'result-btn-replay', quizContainer);

        renderStartButton(() => {
            const lectureUrl = LECTURE_URLS[result.lecture];
            window.open(lectureUrl, '_blank'); 
        }, 'result-btn-signup', quizContainer);
    }

    // --- Á®ãÂºèÁ¢ºÂïüÂãïÈªûÔºöÂä†ÂÖ•Âº∑Âà∂ÂïüÂãï ---
    
    // Ë®àÊôÇÂô®Ôºö3ÁßíÂæåÂº∑Âà∂ÂïüÂãïÔºåÈÅøÂÖçÂç°‰Ωè
    const timeoutId = setTimeout(() => {
        if (!isInitialized) {
            loadingMessage.textContent = 'ÂúñÁâáËºâÂÖ•ÁôºÁîüÂïèÈ°åÔºåÂ∑≤Âº∑Âà∂ÂïüÂãïÊ∏¨È©ó„ÄÇÈÉ®ÂàÜÂúñÁâáÂèØËÉΩÈúÄÊôÇÈñìËºâÂÖ•„ÄÇ';
            startQuiz();
        }
    }, 3000); 

    preloadAllImages().then(() => {
        clearTimeout(timeoutId); 
        console.log('ÊâÄÊúâÂúñÁâáËºâÂÖ•ÂÆåÊàêÔºÅ');
        startQuiz();
    }).catch(error => {
        clearTimeout(timeoutId); 
        console.error('ÊÑèÂ§ñÁöÑÂúñÁâáËºâÂÖ•Â§±Êïó:', error);
    });

</script>

</body>
</html>
